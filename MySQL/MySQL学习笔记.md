# MySQL 学习笔记

[toc]





## 数据库优化要点

### 1. SQL 语句的优化

分析慢查询日志：慢查询日志记录了在 MySQL 中响应时间超过阈值 `long_query_time` 的 SQL 语句，通过日志去找出 IO 大的 SQL 以及未命中索引的 SQL。

使用 `Explain` 进行分析：通过 `Explain` 命令可以得到一条 SQL 语句执行时表的读取顺序、数据读取操作的操作类型、可使用的索引、**实际使用的索引**、表之间的引用以及**扫描的行数**等参数。

- 只返回必要的列：最好不要使用 `SELECT *` 语句。
- 只返回必要的行：使用 `LIMIT` 来限制返回的数据行数。
- 注意引起索引失效的情况：
  - `where` 子句中索引参与表达式计算和函数运算；
  - 以通配符开头的 `LIKE` 模式匹配语句；
  - 数据类型出现隐式转化（如 `varchar` 不加单引号可能自动转换成 `int`）
  - 查询条件中使用了 `or`；
  - 正则表达式不使用索引；
  - 尽量避免在 `where` 子句中使用 `!=`、`<`、`>` 操作符或者对字段进行 null 值判断，否则引擎将放弃使用索引而选择全表扫描；
  - MySQL 优化器会对 SQL 语句进行优化，如果优化器估计使用全表扫描要比使用索引快，则不使用索引。 
- 将一个大连接查询分解成对每一个表进行一次单表查询，然后在应用程序中进行关联，好处有：
  - 让缓存更高效。对于连接查询，如果其中一个表发生变化，那么整个查询缓存就无法使用。而分解后的多个查询，即使其中一个表发生变化，对其它表的查询缓存依然可以使用；
  - 分解成多个单表查询，这些单表查询的缓存结果更可能被其它查询使用到，从而减少冗余的查询；
  - 减少锁竞争。



### 2. 索引的优化

- 注意索引失效的情况（见上面）
- 在合适的字段建立索引：
  - 经常被查询，不经常修改的字段；
  - 经常出现在 `ORDER BY/GROUP BY/DISTINCT` 后面的字段；
  - 经常用作表连接的字段；
  - 应当在小字段上建立索引，避免在大文本或者图片上建立索引（这样会导致 B+ 树中索引占用过多的空间，页的使用率下降）；
  - 建立索引的字段应该非空（含有空值的列难以进行查询优化，会导致统计、比较运算等操作更复杂）；
  - 尽量选择区分度大的字段建立索引；
  - 尽量选择自增主键作为索引（避免了插入和删除数据时可能导致的页分裂、页合并）。



### 3. 数据库表结构的优化

- 设计表时遵循数据库的三大范式；
- 选择合适的数据类型：尽可能不要存储 NULL 字段，使用简单的数据类型；
- 表的水平切分：将同一个表中的记录拆分到多个结构相同的表中（策略：哈希取模；根据ID范围来分）。当一个表的数据不断增多时，这是必然的选择，它可以将数据分布到集群的不同节点上，从而缓解单个数据库的压力； 
- 表的垂直切分：将一张表按列切分成多个表。可以将不常用的字段单独放在同一个表中，把大字段独立放入一个表中，或者把经常使用的字段（关系密切的）放在一张表中。垂直切分之后业务更加清晰，系统之间整合或扩展容易，数据维护简单。



### 4. 系统配置的优化

- 操作系统：增加 TCP 支持的队列数；
- MySQL 配置文件：优化缓存池大小和个数的设置。



### 5. 硬件优化

- 磁盘
- CPU
- 内存
- 集群

